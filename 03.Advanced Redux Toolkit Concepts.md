# Advanced Redux Toolkit Concepts

## Overview

This document covers advanced concepts and techniques for using Redux Toolkit effectively in your applications. It builds upon the foundational knowledge established in the previous documents.

---

## 1. Async Logic with createAsyncThunk

### What is createAsyncThunk?

`createAsyncThunk` is a utility that simplifies the process of handling asynchronous logic in Redux. It allows you to define an action that performs an async operation and automatically dispatches pending, fulfilled, and rejected actions based on the promise lifecycle.

### Example: Fetching Data

Create a new slice for managing data fetching:

```javascript
import { createSlice, createAsyncThunk } from "@reduxjs/toolkit";

export const fetchData = createAsyncThunk("data/fetchData", async (id) => {
	const response = await fetch(`https://api.example.com/data/${id}`);
	return response.json();
});

const dataSlice = createSlice({
	name: "data",
	initialState: {
		items: [],
		status: "idle",
		error: null,
	},
	reducers: {},
	extraReducers: (builder) => {
		builder
			.addCase(fetchData.pending, (state) => {
				state.status = "loading";
			})
			.addCase(fetchData.fulfilled, (state, action) => {
				state.status = "succeeded";
				state.items.push(action.payload);
			})
			.addCase(fetchData.rejected, (state, action) => {
				state.status = "failed";
				state.error = action.error.message;
			});
	},
});

export default dataSlice.reducer;
```

### Key Features of createAsyncThunk

- Automatically handles action types for pending, fulfilled, and rejected states.
- Simplifies async logic without needing to manually dispatch actions.

---

## 2. Normalizing State Shape

### Why Normalize State?

Normalizing state helps to avoid deeply nested structures and makes it easier to manage relationships between entities. This is especially useful in applications with complex data.

### Example: Normalizing Data

When fetching a list of users, you can store them in a normalized format:

```javascript
const initialState = {
	users: {},
	ids: [],
};

const usersSlice = createSlice({
	name: "users",
	initialState,
	reducers: {
		addUser: (state, action) => {
			const user = action.payload;
			state.users[user.id] = user;
			state.ids.push(user.id);
		},
	},
});
```

### Benefits of Normalization

- Easier updates and deletions of entities.
- Simplifies selectors and reduces the need for complex logic.

---

## 3. Memoization with Reselect

### What is Reselect?

Reselect is a library for creating memoized selectors. Memoization helps to optimize performance by caching the results of expensive calculations.

### Example: Creating Selectors

Install Reselect:

```bash
npm install reselect
```

Create a selector using Reselect:

```javascript
import { createSelector } from "reselect";

const selectUsers = (state) => state.users;
const selectUserIds = (state) => state.users.ids;

export const selectAllUsers = createSelector(
	[selectUsers, selectUserIds],
	(users, ids) => ids.map((id) => users[id]),
);
```

### Benefits of Using Reselect

- Reduces unnecessary re-renders in components.
- Improves performance by avoiding recalculations.

---

## 4. Handling Side Effects with Middleware

### Custom Middleware

You can create custom middleware to handle side effects in your application. Middleware can intercept actions and perform additional logic before they reach the reducer.

### Example: Logging Middleware

```javascript
const loggerMiddleware = (store) => (next) => (action) => {
	console.log("Dispatching:", action);
	return next(action);
};
```

### Applying Middleware

When configuring the store, you can apply your custom middleware:

```javascript
import { configureStore } from "@reduxjs/toolkit";

const store = configureStore({
	reducer: rootReducer,
	middleware: (getDefaultMiddleware) =>
		getDefaultMiddleware().concat(loggerMiddleware),
});
```

---

## 5. TypeScript with Redux Toolkit

### Benefits of Using TypeScript

- Provides type safety and autocompletion.
- Helps catch errors during development.

### Example: Defining Types

Define types for your state and actions:

```typescript
interface User {
	id: string;
	name: string;
}

interface UsersState {
	users: Record<string, User>;
	ids: string[];
}
```

### Using Types in createSlice

```typescript
const usersSlice = createSlice({
	name: "users",
	initialState: {} as UsersState,
	reducers: {
		addUser: (state, action: PayloadAction<User>) => {
			const user = action.payload;
			state.users[user.id] = user;
			state.ids.push(user.id);
		},
	},
});
```

---

## 6. Testing Redux Logic

### Testing Reducers

You can test your reducers using Jest:

```javascript
import reducer, { addUser } from "./usersSlice";

test("should handle initial state", () => {
	expect(reducer(undefined, { type: "unknown" })).toEqual({});
});

test("should handle addUser", () => {
	const previousState = {};
	expect(reducer(previousState, addUser({ id: "1", name: "John" }))).toEqual({
		1: { id: "1", name: "John" },
	});
});
```

### Testing Async Logic

You can test async actions using `redux-mock-store` and `jest`:

```javascript
import configureMockStore from "redux-mock-store";
import thunk from "redux-thunk";
import { fetchData } from "./dataSlice";

const middlewares = [thunk];
const mockStore = configureMockStore(middlewares);

const store = mockStore({});

store.dispatch(fetchData(1));
```

---

## 7. Conclusion

In this document, we covered advanced concepts in Redux Toolkit, including async logic, state normalization, memoization, middleware, TypeScript integration, and testing. Mastering these concepts will help you build more efficient and maintainable applications with Redux Toolkit.

---

## 8. Next Steps

- Explore advanced patterns in Redux Toolkit.
- Learn about integrating Redux with React Router.
- Investigate performance optimization techniques.
- Consider using Redux Toolkit Query for data fetching.

---

## Resources

- [Redux Toolkit Documentation](https://redux-toolkit.js.org/)
- [Reselect Documentation](https://github.com/reselect/reselect)
- [TypeScript Documentation](https://www.typescriptlang.org/docs/)
- [Jest Documentation](https://jestjs.io/docs/getting-started)
